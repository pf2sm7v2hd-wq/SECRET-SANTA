<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa æŠ½ç­¾å°å·¥å…·ï¼ˆå¸¦è§„åˆ™æé†’ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC",
        "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #ffe9f0, #f5f7ff);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .card {
      background: #ffffffcc;
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
      max-width: 580px;
      width: 100%;
      padding: 22px 20px 18px;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-bottom: 16px;
    }
    label {
      font-size: 14px;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 8px 10px;
      font-size: 14px;
      resize: vertical;
      outline: none;
    }
    textarea:focus {
      border-color: #ff647a;
      box-shadow: 0 0 0 2px rgba(255, 100, 122, 0.15);
    }
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
      margin-bottom: 10px;
    }
    .options {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0 14px;
      font-size: 13px;
      color: #444;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ff647a, #ff9364);
      color: #fff;
      box-shadow: 0 6px 14px rgba(255, 100, 122, 0.4);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(255, 100, 122, 0.5);
    }
    .btn-secondary {
      background: #f2f3f7;
      color: #555;
    }
    .btn-secondary:hover {
      background: #e4e6ee;
    }
    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .result {
      margin-top: 6px;
      border-radius: 12px;
      background: #fafbff;
      border: 1px solid #e1e4ff;
      padding: 10px;
      max-height: 260px;
      overflow: auto;
      font-size: 13px;
    }
    .result.hidden {
      display: none;
    }
    .result-title {
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      word-break: break-all;
    }
    th, td {
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      border-bottom: 1px solid #ddd;
      font-weight: 600;
      color: #555;
    }
    tr:nth-child(even) td {
      background: #f4f5ff;
    }
    .status {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
    }
    .status.error {
      color: #d93030;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ffe4ea;
      color: #c93652;
      font-size: 11px;
      margin-left: 4px;
    }
    .small {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }
    .hidden {
      display: none;
    }
    @media (max-width: 480px) {
      .card {
        padding: 18px 14px 14px;
      }
      .title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="title">Secret Santa æŠ½ç­¾å°å·¥å…·</div>
    <div class="subtitle" id="subtitleHost">
      ä¸»æŒäººæ¨¡å¼ï¼šå¡«å†™æ‰€æœ‰äººåå­— + æ´»åŠ¨è§„åˆ™ï¼Œç”Ÿæˆ<span class="badge">ä¸“å±é“¾æ¥</span>ï¼Œå‘ç»™æ¯ä¸ªäººå³å¯ ğŸ„
    </div>
    <div class="subtitle hidden" id="subtitleView">
      æŸ¥çœ‹è€…æ¨¡å¼ï¼šè¿™æ˜¯ä½ çš„ä¸“å± Secret Santa æŠ½ç­¾ç»“æœ ğŸ
    </div>

    <!-- ä¸»æŒäººæ¨¡å¼ -->
    <div id="hostMode">
      <label for="names">å‚ä¸è€…åå•</label>
      <textarea id="names" placeholder="ä¾‹å¦‚ï¼š&#10;å°æ&#10;å¯å¯&#10;å°ç‹&#10;é˜¿ä¹&#10;â€¦â€¦"></textarea>
      <div class="hint">
        è‡³å°‘éœ€è¦ 3 ä¸ªäººï¼›å»ºè®®ä½¿ç”¨å¾®ä¿¡æ˜µç§°æˆ–å¤§å®¶éƒ½èƒ½è®¤å‡ºçš„ç§°å‘¼ã€‚
      </div>

      <!-- æ´»åŠ¨è§„åˆ™è®¾ç½® -->
      <label for="ruleBudget">é¢„ç®—ï¼ˆå¯é€‰ï¼‰</label>
      <input id="ruleBudget" type="text" placeholder="ä¾‹å¦‚ï¼š50ï½80 å…ƒ"
             style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #ddd;font-size:14px;margin-bottom:6px;">

      <label for="ruleDeadline">é€è¾¾æ—¶é—´ï¼ˆå¯é€‰ï¼‰</label>
      <input id="ruleDeadline" type="text" placeholder="ä¾‹å¦‚ï¼š12 æœˆ 24 æ—¥æ™šä¸Šå‰"
             style="width:100%;padding:6px 8px;border-radius:8px;border:1px solid #ddd;font-size:14px;margin-bottom:6px;">

      <label for="ruleNote">å…¶ä»–è¦æ±‚ / å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
      <textarea id="ruleNote"
        placeholder="ä¾‹å¦‚ï¼šå°½é‡å®ç”¨ï¼›é¿å…é€åƒä¸å®Œçš„é›¶é£Ÿï¼›ä¸è¦é€é¦™æ°´ / å½©å¦†ï½"
        style="width:100%;min-height:70px;border-radius:10px;border:1px solid #ddd;padding:6px 8px;font-size:14px;"></textarea>

      <div class="options">
        <input type="checkbox" id="noMutual">
        <label for="noMutual" style="margin:0; font-weight:400;">å°½é‡é¿å…äº’ç›¸é€ç¤¼ï¼ˆAâ†’B ä¸” Bâ†’Aï¼‰</label>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="generateBtn">âœ¨ ç”Ÿæˆä¸“å±é“¾æ¥</button>
        <button class="btn-secondary" id="clearBtn">æ¸…ç©ºå†…å®¹</button>
      </div>

      <div class="small">
        ç”Ÿæˆåï¼Œä½ åªä¼šçœ‹åˆ°ã€Œé€ç¤¼äºº + å¯¹åº”çš„ä¸“å±é“¾æ¥ã€ï¼Œä¸ä¼šæ˜¾ç¤ºã€Œé€ç»™è°ã€ã€‚<br>
        æŠŠå¯¹åº”é‚£ä¸€è¡Œçš„é“¾æ¥å¤åˆ¶å‘ç»™é‚£ä¸ªäººï¼Œä»–ç‚¹å¼€å°±èƒ½çœ‹åˆ°è‡ªå·±çš„æ”¶ç¤¼å¯¹è±¡å’Œæ´»åŠ¨è§„åˆ™ã€‚
      </div>

      <div id="resultBox" class="result hidden">
        <div class="result-title">
          <span>é…å¯¹ä¸“å±é“¾æ¥</span>
          <button class="btn-secondary" id="copyAllBtn" style="padding:4px 10px;font-size:12px;">
            å¤åˆ¶æ‰€æœ‰é“¾æ¥
          </button>
        </div>
        <table id="resultTable">
          <thead>
            <tr>
              <th style="width:80px;">é€ç¤¼äºº</th>
              <th>ä¸“å±é“¾æ¥ï¼ˆå¤åˆ¶åå‘ç»™ TAï¼‰</th>
              <th style="width:90px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="status" id="statusText"></div>
      </div>
      <div class="status" id="message"></div>
    </div>

    <!-- æŸ¥çœ‹è€…æ¨¡å¼ -->
    <div id="viewMode" class="hidden">
      <p style="font-size:14px;line-height:1.7;">
        ğŸ… <strong id="viewerGiver"></strong>ï¼Œè¿™æ˜¯ä½ çš„ Secret Santa æŠ½ç­¾ç»“æœï¼š
      </p>
      <p style="font-size:15px;line-height:1.8;">
        ä½ è¦æ‚„æ‚„ç»™ ğŸ‘‰ <strong id="viewerReceiver" style="font-size:16px;"></strong> ğŸ‘ˆ å‡†å¤‡ä¸€ä»½ç¤¼ç‰©ï½
      </p>

      <!-- åœ¨æŸ¥çœ‹é¡µæ˜¾ç¤ºæ´»åŠ¨è§„åˆ™ -->
      <div id="rulesBox" class="small hidden" style="margin-top:10px;">
        <p><strong>æ´»åŠ¨è§„åˆ™æé†’ï¼š</strong></p>
        <p id="vBudget"></p>
        <p id="vDeadline"></p>
        <p id="vNote"></p>
      </div>

      <p class="small" style="margin-top:10px;">
        å¯ä»¥å…ˆè®°ä¸‹æ¥ï¼Œå…³é—­é¡µé¢åä¸‹æ¬¡ç‚¹è¿›åŒä¸€ä¸ªé“¾æ¥ä¹Ÿèƒ½å†çœ‹åˆ°ã€‚<br>
        è¯·ä¸è¦æŠŠè¿™æ¡é“¾æ¥éšä¾¿è½¬ç»™åˆ«äººï¼Œä¸ç„¶å¯¹æ–¹ä¼šçœ‹åˆ°ä½ çš„ç»“æœ ğŸ™ˆ
      </p>
    </div>
  </div>

  <script>
    // å·¥å…·ï¼šè·å– URL å‚æ•°
    function getQueryParam (name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const hostMode = document.getElementById('hostMode');
    const viewMode = document.getElementById('viewMode');
    const subtitleHost = document.getElementById('subtitleHost');
    const subtitleView = document.getElementById('subtitleView');

    const dataParam = getQueryParam('d');

    // å¦‚æœ URL é‡Œå¸¦ d=...ï¼Œè¿›å…¥æŸ¥çœ‹è€…æ¨¡å¼
    if (dataParam) {
      try {
        // è¿™é‡Œä¸ç”¨ atobï¼Œç›´æ¥ decodeURIComponent æ”¯æŒä¸­æ–‡
        const decoded = JSON.parse(decodeURIComponent(dataParam));
        const giverEl = document.getElementById('viewerGiver');
        const receiverEl = document.getElementById('viewerReceiver');
        giverEl.textContent = decoded.giver || 'ä½ ';
        receiverEl.textContent = decoded.receiver || 'æŸä½ç¥ç§˜æœ‹å‹';

        // æ˜¾ç¤ºæ´»åŠ¨è§„åˆ™
        const rulesBox   = document.getElementById('rulesBox');
        const vBudget    = document.getElementById('vBudget');
        const vDeadline  = document.getElementById('vDeadline');
        const vNote      = document.getElementById('vNote');

        let hasRule = false;
        if (decoded.budget) {
          vBudget.textContent = 'ğŸ é¢„ç®—ï¼š' + decoded.budget;
          hasRule = true;
        }
        if (decoded.deadline) {
          vDeadline.textContent = 'â° æ—¶é—´ï¼š' + decoded.deadline;
          hasRule = true;
        }
        if (decoded.note) {
          vNote.textContent = 'ğŸ“Œ å…¶ä»–è¦æ±‚ï¼š' + decoded.note;
          hasRule = true;
        }
        if (hasRule && rulesBox) {
          rulesBox.classList.remove('hidden');
        }

        hostMode.classList.add('hidden');
        subtitleHost.classList.add('hidden');
        viewMode.classList.remove('hidden');
        subtitleView.classList.remove('hidden');
      } catch (e) {
        alert('è¿™ä¸ªé“¾æ¥å¥½åƒæœ‰ç‚¹é—®é¢˜ï¼Œæ— æ³•è§£ææŠ½ç­¾ç»“æœã€‚');
      }
    } else {
      // ä¸»æŒäººæ¨¡å¼
      const namesTextarea = document.getElementById('names');
      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');
      const resultBox = document.getElementById('resultBox');
      const resultTableBody = document.querySelector('#resultTable tbody');
      const statusText = document.getElementById('statusText');
      const message = document.getElementById('message');
      const copyAllBtn = document.getElementById('copyAllBtn');
      const noMutualCheckbox = document.getElementById('noMutual');

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function generateAssignments(names, avoidMutual) {
        const n = names.length;
        let receivers = [...names];
        let attempts = 0;
        const maxAttempts = 2000;

        while (attempts < maxAttempts) {
          attempts++;
          shuffle(receivers);

          // 1. ä¸å…è®¸è‡ªå·±ç»™è‡ªå·±
          let valid = true;
          for (let i = 0; i < n; i++) {
            if (names[i] === receivers[i]) {
              valid = false;
              break;
            }
          }
          if (!valid) continue;

          // 2. å¯é€‰ï¼šé¿å…äº’æŠ½(A->B ä¸” B->A)
          if (avoidMutual) {
            let hasMutual = false;
            for (let i = 0; i < n; i++) {
              const giver = names[i];
              const receiver = receivers[i];
              const j = names.indexOf(receiver);
              if (j !== -1 && receivers[j] === giver) {
                hasMutual = true;
                break;
              }
            }
            if (hasMutual) continue;
          }

          return { receivers, attempts };
        }

        return null;
      }

      generateBtn.addEventListener('click', () => {
        message.textContent = '';
        message.classList.remove('error');

        let names = namesTextarea.value
          .split('\n')
          .map(s => s.trim())
          .filter(s => s.length > 0);

        // å»é‡
        names = [...new Set(names)];

        if (names.length < 3) {
          message.textContent = 'è¯·è‡³å°‘å¡«å†™ 3 ä¸ªä¸åŒçš„åå­—ã€‚';
          message.classList.add('error');
          resultBox.classList.add('hidden');
          return;
        }

        // è¯»å–æ´»åŠ¨è§„åˆ™
        const ruleBudget   = document.getElementById('ruleBudget').value.trim();
        const ruleDeadline = document.getElementById('ruleDeadline').value.trim();
        const ruleNote     = document.getElementById('ruleNote').value.trim();

        const avoidMutual = noMutualCheckbox.checked;
        const result = generateAssignments(names, avoidMutual);

        if (!result) {
          message.textContent = 'å°è¯•å¾ˆå¤šæ¬¡éƒ½æ²¡é…å¥½ç»“æœï¼Œè¯•è¯•å–æ¶ˆâ€œé¿å…äº’ç›¸é€ç¤¼â€å†ç‚¹ä¸€æ¬¡ï½';
          message.classList.add('error');
          resultBox.classList.add('hidden');
          return;
        }

        const { receivers, attempts } = result;

        const baseUrl = window.location.href.split('?')[0];
        resultTableBody.innerHTML = '';
        let allLines = [];

        for (let i = 0; i < names.length; i++) {
          const payload = {
            giver:    names[i],
            receiver: receivers[i],
            budget:   ruleBudget,
            deadline: ruleDeadline,
            note:     ruleNote
          };

          // è¿™é‡Œä¹Ÿä¸ç”¨ btoaï¼Œç›´æ¥ encodeURIComponent + JSONï¼Œæ”¯æŒä¸­æ–‡
          const encoded = encodeURIComponent(JSON.stringify(payload));
          const link = baseUrl + '?d=' + encoded;

          const tr = document.createElement('tr');
          const tdGiver = document.createElement('td');
          const tdLink = document.createElement('td');
          const tdAction = document.createElement('td');

          tdGiver.textContent = names[i];

          const a = document.createElement('a');
          a.href = link;
          a.target = '_blank';
          a.textContent = link;
          tdLink.appendChild(a);

          const copyBtnSingle = document.createElement('button');
          copyBtnSingle.textContent = 'å¤åˆ¶æ­¤é“¾æ¥';
          copyBtnSingle.className = 'btn-secondary';
          copyBtnSingle.style.padding = '4px 10px';
          copyBtnSingle.style.fontSize = '12px';
          copyBtnSingle.addEventListener('click', () => {
            navigator.clipboard.writeText(link).then(() => {
              statusText.textContent = `å·²å¤åˆ¶ ${names[i]} çš„ä¸“å±é“¾æ¥ï½`;
            }).catch(() => {
              statusText.textContent = 'å¤åˆ¶å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨å¤åˆ¶è¯¥è¡Œé“¾æ¥ã€‚';
            });
          });
          tdAction.appendChild(copyBtnSingle);

          tr.appendChild(tdGiver);
          tr.appendChild(tdLink);
          tr.appendChild(tdAction);
          resultTableBody.appendChild(tr);

          allLines.push(names[i] + 'ï¼š' + link);
        }

        resultBox.classList.remove('hidden');
        statusText.textContent = `å·²ä¸º ${names.length} äººç”Ÿæˆä¸“å±é“¾æ¥ï¼ˆå°è¯•æ¬¡æ•°ï¼š${attempts} æ¬¡ï¼‰ã€‚`;
        copyAllBtn.dataset.lines = allLines.join('\n');
      });

      clearBtn.addEventListener('click', () => {
        namesTextarea.value = '';
        document.getElementById('ruleBudget').value = '';
        document.getElementById('ruleDeadline').value = '';
        document.getElementById('ruleNote').value = '';
        resultBox.classList.add('hidden');
        message.textContent = '';
        message.classList.remove('error');
      });

      copyAllBtn.addEventListener('click', () => {
        const text = copyAllBtn.dataset.lines;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
          statusText.textContent = 'å·²å¤åˆ¶æ‰€æœ‰ä¸“å±é“¾æ¥ï¼Œå¯ä»¥ç²˜è´´åˆ°è®°äº‹æœ¬æˆ–å¾®ä¿¡é‡Œæ…¢æ…¢å‘ï½';
        }).catch(() => {
          statusText.textContent = 'å¤åˆ¶å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨é€‰ä¸­è¡¨æ ¼ä¸­çš„å†…å®¹è‡ªå·±å¤åˆ¶ã€‚';
        });
      });
    }
  </script>
</body>
</html>
